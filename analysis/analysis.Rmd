---
title: "Analysis for Muslim Attitudes"
output: 
  html_document: 
    fig_height: 6
    fig_width: 9
    toc: yes
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(here)
source(here("analysis","useful_functions.R"))
source(here("analysis","check_packages.R"))
load(here("analysis","output","analytic_samples.RData"))
```


## Introduction

This R Markdown file will read in the multiply imputed analytic dataset and run a series of multilevel models across countries predicting support for violent practices, as well as a variety of sensitivity analyses.

All figures based on the data are drawn from the first complete dataset constructed through multiple imputation, but models are calculated on all five mulitiply imputed datasets, with adjustments for imputation variability.


## Dependent variable
<a href="#top">Back to top</a>


Before modeling, lets just look at the variation in responses to the three independent variables that make up our construct across countries. 

```{r country_averages, echo=FALSE, warning=FALSE, fig.cap="Dotplot of percentage of Muslim respondents who support three different positions measuring support for violent practices. Countries are ordered from lowest to highest average level of support across all three questions."}
country_agg <- 100*with(analytic_samples[[1]],
     cbind(death_apostasy=tapply(death_apostasy=="Favor",country,mean,na.rm=TRUE),
           stone_adultery=tapply(stone_adultery=="Favor",country,mean,na.rm=TRUE),
           severe_corporal=tapply(severe_corporal=="Favor",country,mean,na.rm=TRUE)))
country.scores <- sort(apply(country_agg,1,mean, na.rm=TRUE))
temp <- as.data.frame.table(country_agg)

colnames(temp) <- c("country","variable","percent")
temp$country <- factor(temp$country,
                       levels=names(country.scores),
                       labels=shortenCountryNames(names(country.scores)))
ncountry <- length(unique(temp$country))
temp$variable <- factor(temp$variable,
                        levels=c("death_apostasy","severe_corporal","stone_adultery"),
                        labels=c("Death for apostasy",
                                 "Severe corporal punishment",
                                 "Adulterers should be stoned"))
ggplot(temp, aes(x=country, y=percent,group=variable))+
  geom_point(aes(colour=variable, shape=variable))+coord_flip()+
  #scale_colour_brewer(palette = "Dark2", name="Value")+
  scale_color_viridis_d(name="Variable", end=0.75)+
  scale_shape_manual(values=c(15,16,17,7,9,10), name="Variable")+
  ylab("Percentage in support")+
  xlab("")+
  ylim(0,100)+
  theme_bw()
```

A few big take homes from this:

1. The variance in support for each practice is highly variable with countries fairly evenly spread out from about 0% in support to about 90% in support. Variance is good from an analytical point of view - there is something worth understanding here. Islamic society is not producing a uniform response.
2. The level of support across outcomes tends to be correlated within countries. So countries with high level of support in one area have high level of support for the others as well, for example. This to some extent validates the factor analysis which found a high degree of correlation at the individual level. 
3. Support for death for apostasy tend to be the least supported of the three in most countries and sometimes trails the other two by substantial margins. Only in the case of Egypt and Jordan was it the most supported. The Egypt and Jordan cases are interesting because this is what drove the metric invariance in the IRT models. 

The figure below shows the distribution of the dependent variable when we add up the number of yes's to each question and then rescale to a mean of 0 and SD of 1.

```{r dist_violence, echo=FALSE, fig.cap="Support for violent practices only has four possible scores. The most common is to answer no on all three questions. The score is interestingly polarized, with the most common answer being yes on all three cases o no on all three cases."}
ggplot(analytic_samples[[1]], aes(x=violence))+
  geom_histogram(color="black",fill="grey")+ 
  geom_vline(xintercept = 0, linetype=2)+
  labs(x="support for violent practices scale")+
  theme_bw()
```

The highest frequencies are those who said no to all three or yes to all three. 

## Multilevel models
<a href="#top">Back to top</a>

The multilevel models are random intercept and random slope models that allow the the intercept and the slopes of certain variables to vary across countries. In mathematical terms, the set-up is:

$$y_{ij}=\beta_{0j}+\beta_{1j}(\texttt{religiosity}_{ij})+\beta_{2j}(\texttt{education}_{ij})+\sum_{k=1}^K \lambda_kx_{kij}+\epsilon_{ij}$$

where $y_{ij}$ is the score on the support for violent practices measures for the $i$th respondent in the $j$th country. The intercept $\beta_{0j}$, and the two slopes of $\beta_{1j}$ and $\beta_{2j}$ on religiosity and education are allowed to vary by country. Note, that while we represent religiosity as a single variable here, we actually estimate it with three separate variables, each of which is allowed to vary by country. The model also includes $K$ additional independent control variables $x_{kij}$ that are not allowed to vary by country. $\epsilon_{ij}$ is an individual-level error term. 

$\beta_{0j}$ measures the average support for support for violent practices in country $j$ and $\beta_{1j}$ and $\beta_{2j}$ measure the relationship between religiosity and education, respectively, and support for violent practices in country $j$. To complete the multilevel model structure, the three country-varying parameters have their own linear equations:

$$\beta_{0j}=\gamma_{01}+\gamma_{02}z_j+\delta_j$$
$$\beta_{1j}=\gamma_{11}+\gamma_{12}z_j+\eta_j$$
$$\beta_{2j}=\gamma_{21}+\gamma_{22}z_j+\tau_j$$

The three country level error terms $\delta_j$, $\eta_j$ and $\tau_j$ are important because they provide the country level random effects for each country that tell us how different each country is from the average in terms of the intercept and two slopes, respectively. I put no restrictions on the correlation in these error terms for the analysis, in order to see how they are empirically correlated in the data.

The $z_j$ is a country-level variable that can be added to the analysis. In the initial models, I leave out all country-level variables in order to estimate models with only individual level effects. I then consider some different candidate variables for $z_j$. Note that the use of $z_j$ in the two slopes models is effectively an interaction term between education/religiosity and the $z_j$ variable. 

In all models, independent variables are centered on the grand mean. For country level variables they are mean centered based on the country level mean. I scale all quantitative variables by twice the standard deviation. 

### Individual-level models
<a href="#top">Back to top</a>

We begin with a model which only allows the religiosity and education slopes to vary across countries, but adds no country level predictors. 

```{r random_models, echo=FALSE, results='asis'}
formula_baseline <- formula(violence~(1+attend.scale+relig_important.scale+
                                        prayer.scale+educqq_scl|country)+
                              attend.scale+relig_important.scale+
                              prayer.scale+educqq_scl)
formula_demog <- update(formula_baseline, .~.+incomeqq_scl+
                          age25_29+age30_34+age35_39+age40_44+
                          age45_49+age50_54+age55_59+ageAge60orover+
                          Female+Urban+Shia+Other+Nothinginparticular+sufi_ctr)
formula_theocons <- update(formula_demog, .~.+NecessarytobelieveinGodtobemoral+
                             islam_truth_ctr+islam_oneway_ctr)
formula_attitudes <- update(formula_theocons, .~.+conflict_modern_ctr+
                              western_culture+western_immoral+
                              anti_democratic_ctr+
                              social_cons_death+social_cons_sex)

results_baseline <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_baseline, data=x)
}))
results_demog <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_demog, data=x)
}))
results_theocons <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_theocons, data=x)
}))
results_attitudes <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_attitudes, data=x)
}))

#the function for converting back for knitreg will need to be model specific so 
#it goes here and not useful functions
convert_model_re <- function(model) {
  tr <- createTexreg(
    coef.names = names(model$fixef$beta), 
    coef = model$fixef$beta, 
    se = model$fixef$se, 
    pvalues = model$fixef$pvalue,
    gof.names = c("N (individual)","N (country)", "BIC",
                  "SD (education quantile)", "SD (attendance)",
                  "SD (religion important)", "SD (prayer)",
                  "r(intercept, education)","r(intercept, attendance)",
                  "r(intercept, religion important)","r(intercept, prayer)",
                  "r(education, attendance)","r(education, religion important)",
                  "r(education, prayer)","r(attendance, religion important)",
                  "r(attendance, prayer)","r(religion important, prayer)"),
    gof = c(model$sumStats$n, model$sumStats$ngrp, model$sumStats$BIC,
            model$ranef_sd["educqq_scl"], 
            model$ranef_sd["attend.scale"], 
            model$ranef_sd["relig_important.scale"], 
            model$ranef_sd["prayer.scale"], 
            model$ranef_cor["(Intercept)","educqq_scl"],
            model$ranef_cor["(Intercept)","attend.scale"],
            model$ranef_cor["(Intercept)","relig_important.scale"],
            model$ranef_cor["(Intercept)","prayer.scale"],
            model$ranef_cor["educqq_scl","attend.scale"],
            model$ranef_cor["educqq_scl","relig_important.scale"],
            model$ranef_cor["educqq_scl","prayer.scale"],
            model$ranef_cor["relig_important.scale","attend.scale"],
            model$ranef_cor["prayer.scale","attend.scale"],
            model$ranef_cor["relig_important.scale","prayer.scale"]),
    gof.decimal = c(F,F,F,rep(T, 14))
  )
}

knitreg(lapply(list(results_baseline, results_demog, results_theocons, results_attitudes),
               convert_model_re),
        digits=3,
        custom.coef.names=c("Intercept","Mosque attendance","Importance of religion",
                            "Frequency of prayer","Education quantile",
                            "Income quantile","Age 25-29","Age 30-34","Age 35-39",
                            "Age 40-44","Age 45-49","Age 50-54","Age 55-59",
                            "Age 60 and over", "Female", "Urban", "Shia",
                            "Other denomination","Just a Muslim", "Sufi",
                            "Necessary to believe in god to be moral",
                            "Islam is the one true faith",
                            "One way to interpret relig. teachings",
                            "Religion in conflict with modernity",
                            "Dislikes western culture",
                            "Western culture is immoral",
                            "Prefers strong leader to democracy",
                            "Socially conservative scale, death",
                            "Socially conservative scale, sex"),
        single.row=TRUE,
        dcolumn=TRUE,
        caption="Results from multilevel models predicting support for violent practices for violating norms among Muslims.",
        caption.above=TRUE,
        custom.note="%stars Notes: All models include random country-level intercepts and slopes for education and religiosity measures. All quantitative variables are divided by twice their standard deviation for comparability. Results are based on five complete datasets with imputation for missing values.")
```

Lets first talk about the education and religiosity effects. These effects are pretty consistent across models. They do decline in affect somewhat with the inclusion of various control terms, but remain statistically significant and substantively meaningful. In general, the religiosity effects are substantially larger in effect than the education variable. The prayer effect is the single largest effect in the model and the other two effects are also some of the largest effects. In total, religiosity matters more than theological conservativism.


Its important to remember that these are only the average effects across all countries. The SD on each effect shows that there is pretty substantial variation across the education and religiosity slopes across countries. The variation for religion important and prayer are substantially higher than for education or attendance. There is also some interesting stuff going on here with the correlation of random effects, but I am going to look at that more thoroughly in the final models that also adjust for development.

### Country-level effects
<a href="#top">Back to top</a>

I now turn to models that include country-level variables. We want to measure development here and we want to do this parsimoniously, so my preferred measure is the Human Development Index (HDI) which is a composite scale of GDP per capita, life expectancy, and educational attainment in a country. In the set of models below, I first include the HDI as a predictor of the intercept alone to see how HDI affects the average support for violent practices in a country. In the second model, I also include it as a predictor of the slopes for education and religiosity. This allows me to see how HDI might affect the association between support for violent practices and religiosity/education. I think one perspective on modernization theory would expect high HDI to make the educational slope more negative and the religiosity slope less positive. 

```{r hdi_models, echo=FALSE, results='asis'}
formula_hdi_intercept <- update(formula_attitudes, .~.+hdi_scaled)
formula_hdi_full <- update(formula_attitudes, .~.+(attend.scale+relig_important.scale+prayer.scale+educqq_scl)*hdi_scaled)
formula_hdi_restricted <- update(formula_attitudes, .~.+educqq_scl*hdi_scaled)

results_hdi_intercept <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_hdi_intercept, data=x)
}))
results_hdi_full <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_hdi_full, data=x)
}))
results_hdi_restricted <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_hdi_restricted, data=x)
}))

knitreg(lapply(list(results_attitudes, results_hdi_intercept, results_hdi_full,
                    results_hdi_restricted),
               convert_model_re),
        digits=3,
        custom.coef.names=c("Intercept","Mosque attendance","Importance of religion",
                            "Frequency of prayer","Education quantile",
                            "Income quantile","Age 25-29","Age 30-34","Age 35-39",
                            "Age 40-44","Age 45-49","Age 50-54","Age 55-59",
                            "Age 60 and over", "Female", "Urban", "Shia",
                            "Other denomination","Just a Muslim", "Sufi",
                            "Necessary to believe in god to be moral",
                            "Islam is the one true faith",
                            "One way to interpret relig. teachings",
                            "Religion in conflict with modernity",
                            "Dislikes western culture",
                            "Western culture is immoral",
                            "Prefers strong leader to democracy",
                            "Socially conservative scale, death",
                            "Socially conservative scale, sex",
                            "Human development index",
                            "HDI x Mosque attendance", "HDI x Importance of relig",
                            "HDI x Frequency of prayer","HDI x education quantile"),
        single.row=TRUE,
        dcolumn=TRUE,
        caption="Results from multilevel models predicting support for violent practices for violating norms among Muslims.",
        caption.above=TRUE,
        custom.note="%stars Notes: All models include random country-level intercepts and slopes for some variables. All quantitative variables are divided by twice their standard deviation for comparability. Results are based on five complete datasets with imputation for missing values.")
```

In model 2, we can see that the HDI has a big negative effect on support for violent practices. More developed countries have much less support on average for these beliefs. Thats a win for modernization theory, I think. It doesn't do much to the individual level relationships, but we didn't expect it to do so. Interestingly it increases the correlation between the intercept and the education slope substantially. We might want to try to understand what is going on there better. 

In model, we see a fairly substantial *positive* interaction between education and HDI, although barely insignificant. The religiosity interactions are also positive but much smaller substantively. This is not the expectation we had. It implies that the correlation between education and support for violent practices is less negative and possibly more positive in more developed countries. Although its non-sig in model 3, I removed the religiosity interactions in model 4 which are causing some collinearity issues and then you can see the significant effect of the education interaction (not that significance matters in a non-sample, but reviewers might care, sigh). Model 4 is preferred to Model 3 by BIC, unsurprisingly.

To understand this a little better, lets look at the scatterplot of the education slopes from our full individual model and the HDI index for each country. 

```{r}
country_effects <- as_tibble(results_attitudes$country_effects)
colnames(country_effects)[1] <- "intercept"
country_effects$country <- rownames(results_attitudes$country_effects)
temp <- subset(analytic_samples[[1]], !duplicated(country),
               select=c("country","hdi"))
country_effects <- merge(country_effects, temp)
ggplot(country_effects, aes(x=hdi, y=educqq_scl))+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="human development index",
       y="random education slopes, full individual model")+
  theme_bw()
```

Yes, there is definitely a positive correlation here. Tunisia is again an outlier. One might argue that there is some regionalism going on here. A lot of African countries in the low HDI range and more MENA countries at the high HDI range. But I think there are enough other countries mixed in there that its not simply a regionalism story, or a "Bad Arab" story. 

While we are at it, lets go ahead and look at the intercept/HDI correlation.

```{r}
ggplot(country_effects, aes(x=hdi, y=intercept))+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="human development index",
       y="random intercepts, full individual model")+
  theme_bw()
```

As expected, a pretty strong negative correlation there. Its interesting how there is a group of countries with the highest intercepts that seem to float above the rest of the scatterplot. However even among this group we see the same downward trend. Its like there is some invisible dummy variable separating two parallel lines. However, its hard to easily classify those countries. They are mostly MENA countries, with the exception of Malaysia so I suppose we might have a residual MENA effect here. 

### Random Components Analysis

Ok, now lets look at the correlations between the random slopes and intercepts. I am going to use Model 4 above which includes HDI and the interaction between HDI and the education quantile.

```{r country-effects}
country_effects <- as_tibble(results_hdi_restricted$country_effects)
colnames(country_effects)[1] <- "intercept"
country_effects$country <- rownames(results_hdi_restricted$country_effects)
```


```{r}
ggplot(country_effects, aes(x=intercept, y=educqq_scl))+
  geom_hline(yintercept=0, linetype=2)+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="intercept in country", y="education slope in country")+
  theme_bw()
```

We see a positive correlation between education slope and average overall support for violent practices. We also see a substantial minority of countries in which the relationship between education and support for violent practices is estimated to be positive. Egypt is the most notable example. 

Overall this seems to support the socialization hypothesis. Education has the biggest "liberalizing" effect in countries with more liberal views overall and it has a conservatizing effect in countries with the most conservative views.

Tunisia is a clear outlier here, although its general placement is consistent with the overall relationship. Education has a big negative effect in a country with already low support. I find the contrast with Algeria at the other end of the spectrum fascinating. Its not about "culture."


```{r}
ggplot(country_effects, aes(x=intercept, y=attend.scale))+
  geom_hline(yintercept=0, linetype=2)+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="intercept in country", y="attendance slope in country")+
  theme_bw()
```

```{r}
ggplot(country_effects, aes(x=intercept, y=relig_important.scale))+
  geom_hline(yintercept=0, linetype=2)+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="intercept in country", y="religion importance slope in country")+
  theme_bw()
```

```{r}
ggplot(country_effects, aes(x=intercept, y=prayer.scale))+
  geom_hline(yintercept=0, linetype=2)+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="intercept in country", y="prayer frequency slope in country")+
  theme_bw()
```

Some interesting patterns here that suggest these different measures of religiosity are not all operating in the same way. For religion important and prayer, we see a somewhat similar positive association. Notably, almost all of the countries are on the positive side of the line here though, suggesting that liberalization in a country may reduce the conservatizing effects of religiosity here but it does not "flip" them to become liberalizing effects, for the most part. The effects are weaker for religion is important though and we do see more "flipped" cases here. This variable is less tied to actually religious practice and thus less institutionalized and thus it may be easier to flip in this regard and less tied to socialization.

The relationship between the attendance slope and the overall values of the country does not work like the other two. The relationship here is slightly negative. This suggests that Mosque attendance tends to get more conservatizing in the most liberal countries. It works contrary to the socialization hypothesis. Not entirely sure what to make of that. Attendance at Mosque is the most institutionalized measure of religiosity - it suggests that Mosques and schools work very differently.


```{r}
ggplot(country_effects, aes(x=attend.scale, y=educqq_scl))+
  geom_hline(yintercept=0, linetype=2)+
  geom_vline(xintercept=0, linetype=2)+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="attendance slope in country", y="education slope in country")+
  theme_bw()
```

```{r}
ggplot(country_effects, aes(x=relig_important.scale, y=educqq_scl))+
  geom_hline(yintercept=0, linetype=2)+
  geom_vline(xintercept=0, linetype=2)+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="religion is important slope in country", y="education slope in country")+
  theme_bw()
```

```{r}
ggplot(country_effects, aes(x=prayer.scale, y=educqq_scl))+
  geom_hline(yintercept=0, linetype=2)+
  geom_vline(xintercept=0, linetype=2)+
  geom_point()+
  geom_smooth(method="lm", se=FALSE)+
  geom_text_repel(aes(label=country))+
  labs(x="prayer slope in country", y="education slope in country")+
  theme_bw()
```

These relationships are fascinating. All of the correlations are pretty strong, but they are not all in the same direction. Both the attendance and religion important slopes are negatively related to education. This suggests strong effects of *polarization* - what is pushing educational institutions to be more liberal is also pushing attendance and religion is important to be more conservatizing (or vice versa in a few unusual but notable cases). The effect is particularly noticeable for attendance, where Egypt and Tunisia nicely bookend the scatterplot with completely opposite patterns. 

The relationship between prayer and education slopes is also strong (the strongest in fact), but in the opposite direction. Here we see a pattern of *synchronization* - in countries where education has a more liberalizing effect, prayer has a less conservatizing effect. 

The patterns for attendance combined tell an interesting story about the role of Mosques. Mosques are resistant to the overall liberalization of a country and serve as a counter to the liberalization of the educational system. The other two forms of religiosity, less dependent on the formal religious organization, show less evidence of resistance in one form or another. 

### Sensitivity Analysis

#### Separate models for each outcome

Because the dependent variable construct failed to achieve scalar invariance, it is possible that it is not a good construct. In such a case, the alternative would be to model each of the items separately. To test whetehr the construct is reasonable, I estimate separate multilevel logit models for each of the component items. I then compare the model parameters in each of these models to determine whether they produce similar effects. If the effect of each model is similar in terms of both covariates and the correlation of random components, then this strongly suggests that the use of model using a construct is a reasonable data reduction approach. 

```{r item-models, echo=FALSE, results='asis'}
results_apostasy <- pool_re_models(mclapply(analytic_samples, function(x) {
  glmer.converge(update(formula_hdi_restricted, (death_apostasy=="Favor")~.), 
                 data=x)
}))
results_stoning <- pool_re_models(mclapply(analytic_samples, function(x) {
  glmer.converge(update(formula_hdi_restricted, (stone_adultery=="Favor")~.), 
                 data=x)
}))
results_corporal <- pool_re_models(mclapply(analytic_samples, function(x) {
  glmer.converge(update(formula_hdi_restricted, (severe_corporal=="Favor")~.), 
                 data=x)
}))


knitreg(lapply(list(results_hdi_restricted, results_apostasy, 
                    results_stoning, results_corporal),
               convert_model_re),
        digits=3,
        custom.coef.names=c("Intercept","Mosque attendance","Importance of religion",
                            "Frequency of prayer","Education quantile",
                            "Income quantile","Age 25-29","Age 30-34","Age 35-39",
                            "Age 40-44","Age 45-49","Age 50-54","Age 55-59",
                            "Age 60 and over", "Female", "Urban", "Shia",
                            "Other denomination","Just a Muslim", "Sufi",
                            "Necessary to believe in god to be moral",
                            "Islam is the one true faith",
                            "One way to interpret relig. teachings",
                            "Religion in conflict with modernity",
                            "Dislikes western culture",
                            "Western culture is immoral",
                            "Prefers strong leader to democracy",
                            "Socially conservative scale, death",
                            "Socially conservative scale, sex",
                            "Human development index","HDI x education quantile"),
        single.row=TRUE,
        dcolumn=TRUE,
        custom.model.names=c("Construct","Death for Apostasy","Stoning Adulterers","Corporal punishment"),
        caption="Results from multilevel models predicting support for each component of the violent practices measure among Muslims.",
        caption.above=TRUE,
        custom.note="%stars Notes: All models include random country-level intercepts and slopes for some variables. Models for separate items are estimated by a logit model and thus parameters will not scale directly to the construct model. All quantitative variables are divided by twice their standard deviation for comparability. Results are based on five complete datasets with imputation for missing values.")
```

The results here are pretty clear. Almost all of the regression slopes and the random effect correlations are of similar relative magnitude and in the same direction. There is certainly some variation in the strength of parameters across items and occasionally things drop in and out of statistical significance, but overall the results are remarkably similar, particularly for the things we care about. The most notable difference is the correlation between attendance and religion important which goes from positive to negative across the items. However, this is not a correlation I am particularly interested in and all of the other correlations are very stable across items. 

As one final check, lets look at the correlation of the intercepts in the three separate models in comparison to the construct itself. 

```{r cor-intercepts}
intercepts <- tibble(intercept_construct=results_hdi_restricted$country_effects[,1],
                     intercept_apostasy=results_apostasy$country_effects[,1],
                     intercept_stoning=results_stoning$country_effects[,1],
                     intercept_corporal=results_corporal$country_effects[,1])
round(cor(intercepts), 3)
```

All three intercepts are strongly correlated with the construct and with each other. We do not get a different story about the levels of countries when we fit three separarte models as when we fit a single construct model. 

So, I think this sensitivity analysis should close the book on this measurement invariance odyssey. 



#### Alternate development measure

I consider how consistent the results are for the final model if I use a logged GDP measure rather than HDI.

```{r gdp_models, echo=FALSE, results='asis'}
formula_gdp <- update(formula_attitudes, .~.+educqq_scl*lgdpcap_scaled)
results_gdp <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_gdp, data=x)
}))

knitreg(lapply(list(results_hdi_restricted, results_gdp),
               convert_model_re),
        digits=3,
        custom.coef.names=c("Intercept","Mosque attendance","Importance of religion",
                            "Frequency of prayer","Education quantile",
                            "Income quantile","Age 25-29","Age 30-34","Age 35-39",
                            "Age 40-44","Age 45-49","Age 50-54","Age 55-59",
                            "Age 60 and over", "Female", "Urban", "Shia",
                            "Other denomination","Just a Muslim", "Sufi",
                            "Necessary to believe in god to be moral",
                            "Islam is the one true faith",
                            "One way to interpret relig. teachings",
                            "Religion in conflict with modernity",
                            "Dislikes western culture",
                            "Western culture is immoral",
                            "Prefers strong leader to democracy",
                            "Socially conservative scale, death",
                            "Socially conservative scale, sex",
                            "Human development index", "HDI x education quantile",
                            "GDP per capita (logged)","log GDP x education quantile"),
        single.row=TRUE,
        dcolumn=TRUE,
        caption="Results from multilevel models predicting support for violent practices for violating norms among Muslims.",
        caption.above=TRUE,
        custom.note="%stars Notes: All models include random country-level intercepts and slopes for some variables. All quantitative variables are divided by twice their standard deviation for comparability. Results are based on five complete datasets with imputation for missing values.")
```

The results generally support our basic conclusions with the HDI measure, although the results for the interaction term are not statistically significant, because the effect is a little smaller. I don't care much about that since our level 2 is not a random sample anyway. 

#### Alternative education measures

As an alternative education measure, we have the categorical variable for highest attainment of secondary, or post-secondary. Lets see how these terms do instead of the education quantile.

```{r education_sensitivity_models, echo=FALSE, results='asis'}
formula_ed_alt_individ <- formula(violence~(1+attend.scale+relig_important.scale+
                                              prayer.scale+Secondary+Post_Secondary|country)+
                                    attend.scale+relig_important.scale+
                                    prayer.scale+Secondary+Post_Secondary+incomeqq_scl+
                                    age25_29+age30_34+age35_39+age40_44+
                                    age45_49+age50_54+age55_59+ageAge60orover+
                                    Female+Urban+Shia+Other+Nothinginparticular+sufi_ctr+
                                    NecessarytobelieveinGodtobemoral+
                                    islam_truth_ctr+islam_oneway_ctr+conflict_modern_ctr+
                                    western_culture+western_immoral+
                                    anti_democratic_ctr+
                                    social_cons_death+social_cons_sex)
formula_ed_alt_hdi <- update(formula_ed_alt_individ, 
                          .~.+(Secondary+Post_Secondary)*hdi_scaled)


results_ed_alt_individ <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_ed_alt_individ, data=x)
}))
results_ed_alt_hdi <- pool_re_models(mclapply(analytic_samples, function(x) {
  lmer.converge(formula_ed_alt_hdi, data=x)
}))

#the function for converting back for knitreg will need to be model specific so 
#it goes here and not useful functions
convert_model_re_educ <- function(model) {
  tr <- createTexreg(
    coef.names = names(model$fixef$beta), 
    coef = model$fixef$beta, 
    se = model$fixef$se, 
    pvalues = model$fixef$pvalue,
    gof.names = c("N (individual)","N (country)", "BIC",
                  "SD (Secondary)", 
                  "SD (Post-Secondary)", 
                  "SD (attendance)",
                  "SD (religion important)", 
                  "SD (prayer)",
                  "r(intercept, secondary)",
                  "r(intercept, post-secondary)",
                  "r(intercept, attendance)",
                  "r(intercept, religion important)",
                  "r(intercept, prayer)",
                  "r(secondary, attendance)",
                  "r(post-secondary, attendance)",
                  "r(secondary, religion important)",
                  "r(post-secondary, religion important)",
                  "r(secondary, prayer)",
                  "r(post-secondary, prayer)",
                  "r(secondary, post-secondary)",
                  "r(attendance, religion important)",
                  "r(attendance, prayer)",
                  "r(religion important, prayer)"),
    gof = c(model$sumStats$n, model$sumStats$ngrp, model$sumStats$BIC,
            model$ranef_sd["Secondary"], 
            model$ranef_sd["Post_Secondary"], 
            model$ranef_sd["attend.scale"], 
            model$ranef_sd["relig_important.scale"], 
            model$ranef_sd["prayer.scale"], 
            model$ranef_cor["(Intercept)","Secondary"],
            model$ranef_cor["(Intercept)","Post_Secondary"],
            model$ranef_cor["(Intercept)","attend.scale"],
            model$ranef_cor["(Intercept)","relig_important.scale"],
            model$ranef_cor["(Intercept)","prayer.scale"],
            model$ranef_cor["Secondary","attend.scale"],
            model$ranef_cor["Post_Secondary","attend.scale"],
            model$ranef_cor["Secondary","relig_important.scale"],
            model$ranef_cor["Post_Secondary","relig_important.scale"],
            model$ranef_cor["Secondary","prayer.scale"],
            model$ranef_cor["Post_Secondary","prayer.scale"],
            model$ranef_cor["Secondary","Post_Secondary"],
            model$ranef_cor["relig_important.scale","attend.scale"],
            model$ranef_cor["prayer.scale","attend.scale"],
            model$ranef_cor["relig_important.scale","prayer.scale"]),
    gof.decimal = c(F,F,F,rep(T, 20))
  )
}

knitreg(lapply(list(results_ed_alt_individ, results_ed_alt_hdi),
               convert_model_re_educ),
        digits=3,
        custom.coef.names=c("Intercept","Mosque attendance","Importance of religion",
                            "Frequency of prayer","Secondary","Post-Secondary",
                            "Income quantile","Age 25-29","Age 30-34","Age 35-39",
                            "Age 40-44","Age 45-49","Age 50-54","Age 55-59",
                            "Age 60 and over", "Female", "Urban", "Shia",
                            "Other denomination","Just a Muslim", "Sufi",
                            "Necessary to believe in god to be moral",
                            "Islam is the one true faith",
                            "One way to interpret relig. teachings",
                            "Religion in conflict with modernity",
                            "Dislikes western culture",
                            "Western culture is immoral",
                            "Prefers strong leader to democracy",
                            "Socially conservative scale, death",
                            "Socially conservative scale, sex",
                            "Human development index",
                            "HDI x Secondary",
                            "HDI x Post-Secondary"),
        single.row=TRUE,
        dcolumn=TRUE,
        caption="Results from multilevel models predicting support for violent practices for violating norms among Muslims.",
        caption.above=TRUE,
        custom.note="%stars Notes: All models include random country-level intercepts and slopes for religiosity and education. All quantitative variables are divided by twice their standard deviation for comparability. Results are based on five complete datasets with imputation for missing values.}")
```

The results here are very consistent with the education quantile measure. Both secondary and post-secondary have similar effects although post-secondary is not much greater than secondary, suggesting that this is the key difference. The random slopes for each variable are also highly correlated at aron an $r$ of 0.75. Furthermore when you look at the correlation with random intercepts and the religiosity random slopes, all of the correlations are in the same direction for the two variables. The correlations tend to be stronger for post-secondary than secondary, but the first order point is they appear to both move in the same direction. 


Lets look more closely at that correlation between the random effects for the two educational measures.

```{r}
country_effects <- as_tibble(results_ed_alt_hdi$country_effects)
colnames(country_effects)[1] <- "intercept"
country_effects$country <- rownames(results_ed_alt_hdi$country_effects)
ggplot(country_effects, aes(x=Secondary, y=Post_Secondary))+
  geom_hline(yintercept=0, linetype=2)+
  geom_vline(xintercept=0, linetype=2)+
  geom_abline(slope=1, color="blue", linetype=2)+
  geom_point()+
  geom_text_repel(aes(label=country))+
  labs(x="secondary education slope", y="post-secondary education slope")+
  theme_bw()
```

That is a pretty tight correlation. Ghana and Egypt are the most notable outliers, but both in a consistent direction. Only a couple cases of effects in opposite direction but in those cases one or more effect is close to zero. Overall, the results here are a win for parsimony.
