---
title: "Exploratory Factor Analysis"
output: 
  html_document: 
    toc: yes
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(psych)
library(corrgram)
load(here("analysis","output","pewdata_combined.RData"))
rotation_choice <- "oblimin"
```

## Introduction

This document will describe and analyze the variables we are using to create several different constructs for key independent and dependent variables. Each section will describe a specific construct and what variables we initially considered as candidates for loading into the construct. It will then perform an exploratory factor analysis to see how well the variables actually load into a single factor. 

Four of the factors (support for violent practices, anti-secularism, and support for women's rights) represent potential dependent variables for the analysis, while four other constructs (religiosity, theological conservatism, social conservatism, and attitudes toward the west) represent potential independent variables.

In each case, we use a correlogram to graphically examine correlations between variables and a cronbach's $\alpha$ to test the adequacy of a single common factor across all items. We then run a full exploratory factor analysis where we look at several diagnostics (VSS, empirical Bayes, etc.) for the optimal number of factors and then examine factor loadings across models with different numbers of factor loadings. We also include a final section for the independent and dependent variables where we load all of our candidate variables across all constructs into a single factor analysis to see if the results separate in the expected manner.  

We use EFA with oblimin (oblique) rotation rather than PCA for the analysis. There is considerable debate about which technique is more appropriate, a lot of which hinges on whether the goal is to truly identify a latent construct or just provide a simple data reduction of collinear terms - which strike me as theoretical not always separable. In most cases, the techniques produce similar resuls. We have also repeated the anlalysis here with PCA and reached the same conclusion. We note below the only case where PCA produced a notable difference. 

## Religiosity 
<a href="#top">Back to top</a>

This is a classic measure in studies of religion in the Western context, but is often used as a multi-dimensional construct measuring a variety of different concepts. We are using it as a measure of the intensity of religious belief and practice in a person's life, separate from specific kinds of practices, rituals, and beliefs. We are considering the four variables below. 

+------------------------+--------------------------------------+---------------------------+
| Name                   | Question                             | Missing Countries         |
+========================+======================================+===========================+
| attend  (Q34)          | Frequency of mosque attendance       |                           |
+------------------------+--------------------------------------+---------------------------+
| relig_important (Q36)  | How important is religion in life?   |                           |
+------------------------+--------------------------------------+---------------------------+
| prayer (Q61)           | How often do you pray?               |                           |
+------------------------+--------------------------------------+---------------------------+
| read_koran (Q65)       | How often read/listen to Koran?      | - Sub-saharan Africa      |
+------------------------+--------------------------------------+---------------------------+
| follow_prophet (Q59)   |How much does the way you live        | - Sub-saharan Africa     |
|                        |reflect saying and actions of Mohammed|                          |
+------------------------+--------------------------------------+--------------------------+

The Koran and follow the prophet variables will likely have to be removed for the full analysis because they were not measured in the African sample. I am also a little concerned about the attendance variable. It is a common component of religiosity measures in the west but mosque attendance is not as regularized in Islam as church attendance is in Christianity. Furthermore, mosque attendance prescriptions are different for men and women.

```{r religiosity}
religiosity <- cbind(attend=as.numeric(pew$attend), 
                     relig_important=as.numeric(pew$relig_important),
                     prayer=as.numeric(pew$prayer), 
                     read_koran=as.numeric(pew$read_koran),
                     follow_prophet=as.numeric(pew$follow_prophet))
corrgram(religiosity, upper.panel="panel.cor", order="PCA")

alpha(cor(religiosity, use="pairwise.complete.obs"))

nfactors(cor(religiosity, use="pairwise.complete.obs"))

loadings(fa(cor(religiosity, use="pairwise.complete.obs"),1,rotate=rotation_choice))
fa.diagram(fa(cor(religiosity, use="pairwise.complete.obs"),1,rotate=rotation_choice))

loadings(fa(cor(religiosity, use="pairwise.complete.obs"),2,rotate=rotation_choice))
fa.diagram(fa(cor(religiosity, use="pairwise.complete.obs"),2,rotate=rotation_choice))

#follow the prophet stands out as a bit different, what if we removed it?
loadings(fa(cor(religiosity[,-5], use="pairwise.complete.obs"),1,rotate=rotation_choice))

#given that read_koran is not available for SS African, how does it look without it
alpha(cor(religiosity[,c(-4,-5)], use="pairwise.complete.obs"))
loadings(fa(cor(religiosity[,c(-4,-5)], use="pairwise.complete.obs"),1,rotate=rotation_choice))

#check on gender issue with attendance
100*round(prop.table(table(pew$attend, pew$gender),2),3)
```

### Summary

As the analysis above shows, the religiosity measures did hang together pretty well as a single factor. Cronbach's $\alpha$ was reasonably high and the factor loadings from the EFA were also strong, although somewhat weaker for the follow_prophet variable. Additionally, when split into two factors, the follow_prophet variable seems to have some distinctiveness. There is also a potential issue with attendance, because the expectation about mosque attendance is different for men and women. This expectation shows up in the data where women attend mosque far less regularly. This may make attendance slightly problematic for measuring religiosity, because women will incorrectly look like they have less religiosity.

Based on these results and data availability, I recommend that we construct a scale using attend, relig_important, and prayer in order to maximize sample size.  These variables are available across all countries and hang together well as a single factor.  


## Theological Conservatism
<a href="#top">Back to top</a>

Theological conservatism is a common characteristic in studies of religion in the West. Olson and Carroll have created a composite variable from the GSS data in the US. Theological conservatism measures the importance of literalism and orthodoxy in religious belief. These are the candidate variables that we are considering as part of theological conservatism. 

+------------------------+---------------------------------------+---------------------------+
| Name                   | Question                              | Missing Countries         |
+========================+=======================================+===========================+
| believe_moral (Q16)    |Necessary to believe in god to be moral| - Afghanistan             |
+------------------------+---------------------------------------+---------------------------+
| islam_truth (Q55)      |Islam is the one true faith            | - Afghanistan             |
|                        |                                       | - Iran                    |
+------------------------+---------------------------------------+---------------------------+
| islam_oneway (Q57)     |One way to interpret religious teaching| - Iran                    |
+------------------------+---------------------------------------+---------------------------+
| follow_prophet (Q59)   |How much does the way you live         | - Sub-saharan Africa      |
|                        |reflect saying and actions of Mohammed |                           |
+------------------------+---------------------------------------+---------------------------+
| sharia_god (Q66)       | Sharia is the revealed word of God    | - Iran                    |
|                        | (SS African sample asks similar       |                           |
|                        | question about Koran)                 |                           |
+------------------------+---------------------------------------+---------------------------+
| sharia_oneway (Q67)    | There is only one true understanding  | - Iran                    |
|                        | of Sharia                             | - Sub-saharan Africa      |
|                        | (SS African sample asks similar       |                           |
|                        | question about Koran)                 |                           |
+------------------------+---------------------------------------+---------------------------+

Note that follow_prophet shows up as a candidate variable here as well as for religiosity. Also note that we are missing two of these variables for SS Africa and the sharia_god question also had a different question wording in the SS Africa sample. 

```{r theocons}
theocons <- cbind(believe_moral=as.numeric(pew$believe_moral),
                  islam_truth=as.numeric(pew$islam_truth), 
                  islam_oneway=as.numeric(pew$islam_oneway),
                  follow_prophet=as.numeric(pew$follow_prophet),
                  sharia_god=as.numeric(pew$sharia_god),
                  sharia_oneway=as.numeric(pew$sharia_oneway))
corrgram(theocons, upper.panel="panel.cor", order="PCA")

alpha(cor(theocons, use="pairwise.complete.obs"))

nfactors(cor(theocons, use="pairwise.complete.obs"))

loadings(fa(cor(theocons, use="pairwise.complete.obs"),1,rotate=rotation_choice))
fa.diagram(fa(cor(theocons, use="pairwise.complete.obs"),1,rotate=rotation_choice))
loadings(fa(cor(theocons, use="pairwise.complete.obs"),2,rotate=rotation_choice))
fa.diagram(fa(cor(theocons, use="pairwise.complete.obs"),2,rotate=rotation_choice))
loadings(fa(cor(theocons, use="pairwise.complete.obs"),3,rotate=rotation_choice))
fa.diagram(fa(cor(theocons, use="pairwise.complete.obs"),3,rotate=rotation_choice))

#what if I just limit it to the three with full data and fairly high loadings together
alpha(cor(theocons[,1:3], use="pairwise.complete.obs"))
loadings(fa(cor(theocons[,1:3], use="pairwise.complete.obs"),1,rotate=rotation_choice))
```

### Summary

The variables for theological conservatism did not hold together well. Cronback's $\alpha$ is low and a lot of the factor loadings are low as well. When split into two or three factors, nothing really holds together in a meaningful way. 

Based on these results, I would recommend that we not create a scale here, but that we consider including islam_truth, islam_oneway, and believe_moral as separate independent variables. 

## Social conservatism
<a href="#top">Back to top</a>

Social conservatism all relate to Q84. Respondents were asked whether the following behaviors were morally acceptable, morally wrong, or not a moral issue. 

- Divorce
- Polygamy (left out because it correlates with nothing else)
- Limiting the number of children (Not asked in Iran or Sub-Saharan Africa)
- Drinking Alcohol
- Euthanasia
- Suicide
- Abortion
- Prostitution (not asked in Afghanistan and Iran)
- Sex between people who are not married to each other (not asked in Afghanistan and Iran)
- Homosexual behavior (not asked in Afghanistan and Iran)

This question was not asked at all in Morocco and Uzbekistan.

Many of the responses may indirectly relate to religious beliefs but they do not specifically ask about a connection to religious belief. Thus this gives us a way to separate religiosity and theological conservatism from general social conservatism in the models. 

```{r morality}
morality <- cbind(moral_divorce=as.numeric(pew$moral_divorce),
                  moral_fertility=as.numeric(pew$moral_fertility),
                  moral_alcohol=as.numeric(pew$moral_alcohol),
                  moral_euthansia=as.numeric(pew$moral_euthanasia),
                  moral_suicide=as.numeric(pew$moral_suicide),
                  moral_abortion=as.numeric(pew$moral_abortion),
                  moral_prostitution=as.numeric(pew$moral_prostitution),
                  moral_premar_sex=as.numeric(pew$moral_premar_sex),
                  moral_gay=as.numeric(pew$moral_gay))
corrgram(morality, upper.panel="panel.cor", order="PCA")

alpha(cor(morality, use="pairwise.complete.obs"))

nfactors(cor(morality, use="pairwise.complete.obs"))

loadings(fa(cor(morality, use="pairwise.complete.obs"),1,rotate=rotation_choice))
loadings(fa(cor(morality, use="pairwise.complete.obs"),2,rotate=rotation_choice))
loadings(fa(cor(morality, use="pairwise.complete.obs"),3,rotate=rotation_choice))

#lets diagram two vs three factor solutions
fa.diagram(fa(cor(morality, use="pairwise.complete.obs"),1,rotate=rotation_choice))
fa.diagram(fa(cor(morality, use="pairwise.complete.obs"),2,rotate=rotation_choice))
fa.diagram(fa(cor(morality, use="pairwise.complete.obs"),3,rotate=rotation_choice))

#first two seem a bit problematic - what if we take out?
alpha(cor(morality[,-1*1:2], use="pairwise.complete.obs"))
nfactors(cor(morality[,-1*1:2], use="pairwise.complete.obs"))
loadings(fa(cor(morality[,-1*1:2], use="pairwise.complete.obs"),1,rotate=rotation_choice))
fa.diagram(fa(cor(morality[,-1*1:2], use="pairwise.complete.obs"),1,rotate=rotation_choice))
loadings(fa(cor(morality[,-1*1:2], use="pairwise.complete.obs"),2,rotate=rotation_choice))
fa.diagram(fa(cor(morality[,-1*1:2], use="pairwise.complete.obs"),2,rotate=rotation_choice))

```

### Summary

The morality variables seem to hold together well as a single construct, except for the moral_divorce and moral_fertility items which seem to be tapping something else. There is also a secondary split between the items involving "life and death" (suicide, euthanasia, and abortion) but I don't think there is a need for the complexity of two separate constructs here as the factor loadings and Cronbach's $\alpha$ for a single factor are quite good. I would recommend we these items wihout moral_divorce and moral_fertility to construct a single scale. 


## Attitude toward the west
<a href="#top">Back to top</a>


The pew data includes two questions that directly ask about the respondent's attitude towards "western movies, music, and television." There is also a third variable on whether there is a conflict between religion and modern society. I don't think this will correlate that well with the other two,but I want to check that here. 

+------------------------+---------------------------------------+---------------------------+
| Name                   | Question                              | Missing Countries         |
+========================+=======================================+===========================+
| western_culture (Q17)  |Like/Dislike Western movies, music and | - Wording slightly        |
|                        |television?                            |   different in Iran       |
|                        |                                       | - Lebanon                 |
+------------------------+---------------------------------------+---------------------------+
| western_immoral (Q26)  |Western movies, music, and television  | - Wording slightly        |
|                        |have hurt morality in our country.     |   different in Iran       |
|                        |                                       | - Lebanon                 |
+------------------------+---------------------------------------+---------------------------+
| conflict_modern (Q75)  | Natural conflict between religion and | - Wording slight          |
|                        | modern society.                       |   different in Iran       |
+------------------------+---------------------------------------+---------------------------+

```{r western}
western <- cbind(western_culture=as.numeric(pew$western_culture=="I dislike western music, movies and television"),
                  western_immoral=as.numeric(pew$western_immoral),
                  conflict_modern=as.numeric(pew$conflict_modern))
corrgram(western, upper.panel="panel.cor", order="PCA")

alpha(cor(western, use="pairwise.complete.obs"))

loadings(fa(cor(western, use="pairwise.complete.obs"),1,rotate=rotation_choice))
loadings(fa(cor(western[,-3], use="pairwise.complete.obs"),1,rotate=rotation_choice))
```

### Summary

The two westernization questions are reasonably correlated with each other but not with conflict_modern. I would recommend that we combine them into a single scale and keep conflict_modern as a separate variable.

## Separation of Independent Variables
<a href="#top">Back to top</a>

If I combine all four sets of independent variables together after cutting out variables that are missing for SS Africa, how well do they separate into the underlying constructs that I am exploring? 

```{r separate_independent_corrgram, echo=FALSE}
iv <- cbind(religiosity[,1:3],theocons[,1:3],morality,western)

corrgram(iv, upper.panel="panel.cor", order="PCA", cex.labels=0.5)
```

```{r separate_independent_loadings, echo=FALSE}
nfactors(cor(iv, use="pairwise.complete.obs"))

fa_iv <- fa(cor(iv, use="pairwise.complete.obs"),4, rotate = rotation_choice)

loadings(fa_iv)

plot(fa_iv, labels=colnames(iv),
     cluster=c(rep(1,3),rep(2,3),rep(3,9),rep(4,3)))
fa.diagram(fa_iv)
```

When I split them into four factors, they more or less split in the expecterd direction with all the same weak variables as we found earlier (conflict_modern, morality_fertility, morality_divorce) and with poorer results for the theological conservartism variable. If we remove the weak variables and theological conservatism variables, we get very clean results with a three-factor solution (shown below).

```{r separate_independent_loadings2, echo=FALSE}

#take out the problematic cases
iv <- iv[,-c(4,5,6,7,8,18)]
fa_iv <- fa(cor(iv, use="pairwise.complete.obs"), 3, rotate = rotation_choice)

plot(fa_iv, labels=colnames(iv), show.points=FALSE,
     cluster=c(rep(1,3),rep(3,7),rep(4,2)))
fa.diagram(fa_iv)
```

### Summary

The results show the strong separation of the religiosity and morality measures, with the exception of moral_divorce and moral_fertility. It also shows the relative weakness of the theological conservativism variables and the uniqueness of the conflict with modernity. Based on this we will do the following:

- Create a religiosity scale based on attend, prayer, and relig_important. 
- Create a social conservatism scale based on the answer to the morality questions except for moral_fertility and moral_divorce. 
- Create an anti-western culture scale based on western_immoral and western_cultural.
- Include islam_oneway, islam_truth, believe_moral, and conflict_modern in the models as separate variables. 

## Support for violent practices
<a href="#top">Back to top</a>

Here we want to capture whether respondents favor harsh and violent responses to violations of the social fabric/religious norms. So stoning, cutting off hands, honor killings, death for apostasy and the like. There is also a question about whether it is justified to kill civilians in defense of Islam. That variable seems like the closest to a "support for terrorism" variable that we have. 

+------------------------+---------------------------------------+---------------------------+
| Name                   | Question                              | Missing Countries         |
+========================+=======================================+===========================+
| honorkill_man (Q53)    | Justified for family members to kill  | - Iran                    |
|                        |man who dishonors family by premarital | - In Afghanistan, Iraq,   |
|                        |sex or adultery.                       |and Uzbekistan, no ref.    |
|                        |                                       |to permarital sex or       |
|                        |                                       |adultery                   |
|                        |                                       | - Sub-Saharan Africa      |
+------------------------+---------------------------------------+---------------------------+
| honorkill_woman (Q53)  | Justified for family members to kill  | - Iran                    |
|                        |woman who dishonors family by          | - In Afghanistan, Iraq,   |
|                        |premarital sex or adultery.            |and Uzbekistan, no ref.    |
|                        |                                       |to permarital sex or       |
|                        |                                       |adultery                   |
|                        |                                       | - Sub-Saharan Africa      |
+------------------------+---------------------------------------+---------------------------+
| death_apostasy (Q92b)  |Favor the death penalty for people who | - Iran                    |
|                        |leave the Muslim religion              | - Morocco                 |
|                        |                                       | - Uzbekistan              |
+------------------------+---------------------------------------+---------------------------+
| severe_corporal (Q92c) |Favor punishments like whipping or     | - Iran                    |
|                        |cutting off hands for crimes like theft| - Morocco                 |
|                        |and robbery.                           | - Uzbekistan              |
+------------------------+---------------------------------------+---------------------------+
| stone_adultery (Q92d)  |Favor stoning people who commit        | - Iran                    |
|                        |adultery.                              | - Morocco                 |
|                        |                                       | - Uzbekistan              |
+------------------------+---------------------------------------+---------------------------+
| civilian_targets (Q89) | Violence against civilian targets in  | - Iran                    |
|                        | defense of Islam justified.           | - Thailand                |
|                        | I don't think this really goes        | - Uzbekistan              |
|                        | here but may want to consider it      | - Lebanon                 |
|                        | separately.                           |                           |
+------------------------+---------------------------------------+---------------------------+

```{r violent_practices}
violent <- cbind(honorkill_man=as.numeric(pew$honorkill_man),
                  honorkill_woman=as.numeric(pew$honorkill_woman),
                  death_apostasy=as.numeric(pew$death_apostasy),
                  severe_corporal=as.numeric(pew$severe_corporal),
                  stone_adultery=as.numeric(pew$stone_adultery),
                  civilian_target=as.numeric(pew$civilian_target))
corrgram(violent, upper.panel="panel.cor", order="PCA")

alpha(cor(violent, use="pairwise.complete.obs"))

nfactors(cor(violent, use="pairwise.complete.obs"))

loadings(fa(cor(violent, use="pairwise.complete.obs"),1,rotate=rotation_choice))
fa.diagram(fa(cor(violent, use="pairwise.complete.obs"),1,rotate=rotation_choice))
loadings(fa(cor(violent, use="pairwise.complete.obs"),2,rotate=rotation_choice))
fa.diagram(fa(cor(violent, use="pairwise.complete.obs"),2,rotate=rotation_choice))
loadings(fa(cor(violent, use="pairwise.complete.obs"),3,rotate=rotation_choice))
fa.diagram(fa(cor(violent, use="pairwise.complete.obs"),3,rotate=rotation_choice))
fa.diagram(pca(cor(violent, use="pairwise.complete.obs"),3,rotate=rotation_choice))


#remove honor killings and civilian targets
alpha(cor(violent[,c(-1,-2,-6)], use="pairwise.complete.obs"))
vss(cor(violent[,c(-1,-2,-6)], use="pairwise.complete.obs"))
loadings(fa(cor(violent[,c(-1,-2,-6)], use="pairwise.complete.obs"),1,rotate=rotation_choice))
```

### Summary

The results here suggest that while there are decent correlations between all variables, they seem to separate into two groupings. First, honor killings of men and women are highly correlated and are also reasonably correlated with civilian_target. Then death_apostasy, severe_corporal, and stone_adultery hang together well as a single factor. When split into three factors, death_apostasy seems a little different from the other two, but there is a high correlation between the two common factors. Its also worth nothing that when doing a PCA vs. EFA, it is civilian_target that shows up as different in the three factor solution (one of the only cases where EFA and PCA produces somewhat different results in our analysis). 

Honor killing is a little more problematic as a treatment of our dependent variable in my view than death_apostasy, severe_corporal, and stone_adultery because while the other three all have a basis in Islamic scripture, honor killing does not and may be a more locality-specific act. Furthermore, honor killing data is missing for a lot of countries. There are also good theoretical reasons to keep civilian_target separate as a measure of support for more extremist jihadi beliefs. 

Based on the results, my recommendation would be to combine death_apostasy, severe_corporal, and stone_adultery into a single scale of "support for violent practices" and treat civilian_target as a separate dependent variable measuring "support for terrorism." 


